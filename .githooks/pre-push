#!/usr/bin/env bash
set -euo pipefail

echo "WPMoo CLI pre-push: composer validate, PHPCS"

# Allow hard skip via environment variable
if [ "${WPMOO_SKIP_HOOKS:-0}" = "1" ]; then
  echo "(hooks disabled via WPMOO_SKIP_HOOKS=1)"
  exit 0
fi

if command -v composer >/dev/null 2>&1 && [ -f composer.json ]; then
  composer validate --strict --no-check-lock --ansi || exit 1
fi

if [ -x vendor/bin/phpcs ]; then
  echo "→ Running PHPCS (errors only; non-blocking for CLI)"
  if [ -f phpcs.xml ]; then
    vendor/bin/phpcs -n --standard=phpcs.xml src || echo "(PHPCS found issues; continuing)"
  else
    vendor/bin/phpcs -n src || echo "(PHPCS found issues; continuing)"
  fi
fi

echo "✔ Pre-push checks passed"
exit 0
