#!/usr/bin/env php
<?php
/**
 * WPMoo CLI Entry Point.
 *
 * Bootstraps the WPMoo CLI application.
 *
 * @package WPMoo\CLI
 * @since 0.1.0
 * @link  https://wpmoo.org WPMoo â€“ WordPress Micro Object-Oriented Framework.
 * @link  https://github.com/wpmoo/wpmoo GitHub Repository.
 * @license https://spdx.org/licenses/GPL-2.0-or-later.html GPL-2.0-or-later
 */

// Set up error reporting.
error_reporting( E_ALL );
ini_set( 'display_errors', 1 );

// Ensure we're running from the CLI.
if ( PHP_SAPI !== 'cli' ) {
    echo "This script must be run from the command line.\n";
    exit( 1 );
}

/**
 * Searches up the directory tree for the Composer autoloader file.
 * * @param string $startPath The directory to start searching from.
 * @return string|null The full path to the autoloader file, or null if not found.
 */
function find_autoload_file( string $startPath ): ?string {
    $currentDir = $startPath;
    
    // Keep checking parent directories until we hit the root (where dirname() returns the same path).
    while ( dirname( $currentDir ) !== $currentDir ) {
        $autoloadPath = $currentDir . '/vendor/autoload.php';
        
        if ( file_exists( $autoloadPath ) ) {
            return $autoloadPath;
        }
        
        $currentDir = dirname( $currentDir );
    }

    return null;
}

// Find and load the autoloader.
$autoload_file = find_autoload_file( getcwd() );

if ( ! $autoload_file ) {
    // Write the error message to STDERR for proper error handling.
    fwrite( STDERR, "Could not locate Composer autoloader. Run 'composer install'.\n" );
    exit( 1 );
}

require_once $autoload_file;

// Run the CLI application.
use WPMoo\CLI\CLI;

CLI::run( $argv );